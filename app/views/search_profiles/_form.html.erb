<%= form_with model: @search_profile, class: "space-y-8" do |f| %>
  <% if @search_profile.errors.any? %>
    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
      <ul class="list-disc list-inside">
        <% @search_profile.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Transaction type -->
  <div>
    <h3 class="text-lg font-bold text-gray-900 mb-4">üè∑Ô∏è Type de recherche</h3>
    <div class="flex rounded-lg border border-gray-300 overflow-hidden w-fit">
      <% SearchProfile::TRANSACTION_TYPES.each do |type| %>
        <label class="cursor-pointer">
          <input type="radio" name="search_profile[transaction_type]" value="<%= type %>"
                 <%= 'checked' if (@search_profile.transaction_type || 'rental') == type %>
                 class="peer hidden"
                 onchange="updateBudgetLabel(this.value)">
          <span class="block px-6 py-3 text-sm font-medium peer-checked:bg-primary-600 peer-checked:text-white text-gray-700 hover:bg-gray-50 transition-colors">
            <%= SearchProfile::TRANSACTION_TYPE_LABELS[type] %>
          </span>
        </label>
      <% end %>
    </div>
  </div>

  <!-- Location -->
  <div>
    <h3 class="text-lg font-bold text-gray-900 mb-4">üìç Localisation</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="relative">
        <label class="block text-sm font-medium text-gray-700 mb-1">Ville *</label>
        <%= f.text_field :city, required: true, id: "city-input", autocomplete: "off",
            class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500",
            placeholder: "Rechercher une ville..." %>
        <div id="city-suggestions" class="absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
        <%= f.hidden_field :postal_code, id: "postal-code-field" %>
        <%= f.hidden_field :latitude, id: "latitude-field" %>
        <%= f.hidden_field :longitude, id: "longitude-field" %>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Arrondissement / Quartier</label>
        <%= f.text_field :arrondissement, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500", placeholder: "11√®me, Marais, Bastille..." %>
      </div>
    </div>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <div id="city-map" class="mt-4 rounded-lg h-48 z-0" style="background: #f3f4f6;"></div>
  </div>

  <!-- Budget -->
  <div>
    <h3 class="text-lg font-bold text-gray-900 mb-4">üí∞ Budget</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Budget min (<span id="budget-unit-min">‚Ç¨/mois</span>)</label>
        <%= f.number_field :min_budget, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500", placeholder: "500" %>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Budget max (<span id="budget-unit-max">‚Ç¨/mois</span>) *</label>
        <%= f.number_field :max_budget, required: true, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500", placeholder: "1500" %>
      </div>
    </div>
  </div>

  <!-- Surface & Rooms -->
  <div>
    <h3 class="text-lg font-bold text-gray-900 mb-4">üìê Surface & Pi√®ces</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Surface min (m¬≤)</label>
        <%= f.number_field :min_surface, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500", placeholder: "20" %>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Surface max (m¬≤)</label>
        <%= f.number_field :max_surface, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500", placeholder: "60" %>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Pi√®ces min</label>
        <%= f.number_field :min_rooms, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500", placeholder: "1" %>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Pi√®ces max</label>
        <%= f.number_field :max_rooms, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500", placeholder: "3" %>
      </div>
    </div>
  </div>

  <!-- Options -->
  <div>
    <h3 class="text-lg font-bold text-gray-900 mb-4">‚öôÔ∏è Options</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Type de bien</label>
        <%= f.select :property_type, options_for_select(SearchProfile::PROPERTY_TYPES.map { |t| [SearchProfile::PROPERTY_TYPE_LABELS[t], t] }, @search_profile.property_type), { include_blank: "Tous" }, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" %>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">DPE maximum</label>
        <%= f.select :dpe_max, options_for_select(SearchProfile::DPE_RATINGS, @search_profile.dpe_max), { include_blank: "Peu importe" }, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" %>
      </div>
      <div class="flex items-end pb-1">
        <label class="flex items-center cursor-pointer">
          <%= f.check_box :furnished, class: "w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500" %>
          <span class="ml-2 text-sm text-gray-700">Meubl√© uniquement</span>
        </label>
      </div>
    </div>
    <div class="mt-4">
      <label class="block text-sm font-medium text-gray-700 mb-1">Mots-cl√©s</label>
      <%= f.text_field :keywords, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500", placeholder: "balcon, parquet, lumineux..." %>
    </div>
  </div>

  <!-- Platforms -->
  <div>
    <h3 class="text-lg font-bold text-gray-900 mb-4">üåê Plateformes √† surveiller</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <% SearchProfile::PLATFORMS.each do |platform| %>
        <label class="flex items-center p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-primary-300">
          <input type="checkbox" name="search_profile[platforms_to_monitor][]" value="<%= platform %>"
                 <%= 'checked' if @search_profile.platforms&.include?(platform) %>
                 class="w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500">
          <span class="ml-3 text-sm font-medium text-gray-700"><%= platform.capitalize %></span>
        </label>
      <% end %>
    </div>
  </div>

  <!-- Active toggle -->
  <div class="flex items-center">
    <label class="flex items-center cursor-pointer">
      <%= f.check_box :active, class: "w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500" %>
      <span class="ml-2 text-sm text-gray-700 font-medium">Recherche active</span>
    </label>
  </div>

  <!-- Submit -->
  <div class="flex justify-end gap-4">
    <a href="<%= dashboard_path %>" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Annuler</a>
    <button type="submit" class="bg-primary-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-primary-700">
      <%= @search_profile.persisted? ? "Mettre √† jour" : "Cr√©er la recherche" %>
    </button>
  </div>
<% end %>

<script>
  // City autocomplete
  (function() {
    const input = document.getElementById('city-input');
    const suggestions = document.getElementById('city-suggestions');
    const postalField = document.getElementById('postal-code-field');
    const latField = document.getElementById('latitude-field');
    const lngField = document.getElementById('longitude-field');
    let debounceTimer;
    let map, marker;

    // Init map
    function initMap(lat, lng) {
      if (!lat || !lng) {
        lat = 46.603354; lng = 1.888334; // France center
      }
      if (map) {
        map.setView([lat, lng], lat === 46.603354 ? 6 : 12);
        if (marker) marker.setLatLng([lat, lng]);
        else if (lat !== 46.603354) marker = L.marker([lat, lng]).addTo(map);
        return;
      }
      map = L.map('city-map', { scrollWheelZoom: false }).setView([lat, lng], lat === 46.603354 ? 6 : 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      if (lat !== 46.603354) marker = L.marker([lat, lng]).addTo(map);
    }

    // Init with existing coords
    const existingLat = parseFloat(latField.value);
    const existingLng = parseFloat(lngField.value);
    if (existingLat && existingLng) {
      initMap(existingLat, existingLng);
    } else {
      initMap();
    }

    input.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      const query = this.value.trim();
      if (query.length < 2) { suggestions.classList.add('hidden'); return; }
      debounceTimer = setTimeout(() => fetchCities(query), 300);
    });

    input.addEventListener('blur', function() {
      setTimeout(() => suggestions.classList.add('hidden'), 200);
    });

    function fetchCities(query) {
      fetch(`https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(query)}&fields=nom,code,codesPostaux,centre&boost=population&limit=5`)
        .then(r => r.json())
        .then(cities => {
          suggestions.innerHTML = '';
          if (cities.length === 0) { suggestions.classList.add('hidden'); return; }
          cities.forEach(city => {
            const cp = city.codesPostaux && city.codesPostaux[0] || '';
            const div = document.createElement('div');
            div.className = 'px-4 py-3 hover:bg-primary-50 cursor-pointer text-sm border-b border-gray-100 last:border-0';
            div.innerHTML = `<span class="font-medium text-gray-900">${city.nom}</span> <span class="text-gray-400">${cp}</span>`;
            div.addEventListener('mousedown', function(e) {
              e.preventDefault();
              input.value = city.nom;
              postalField.value = cp;
              const coords = city.centre && city.centre.coordinates;
              if (coords) {
                latField.value = coords[1];
                lngField.value = coords[0];
                initMap(coords[1], coords[0]);
              }
              suggestions.classList.add('hidden');
            });
            suggestions.appendChild(div);
          });
          suggestions.classList.remove('hidden');
        })
        .catch(() => suggestions.classList.add('hidden'));
    }
  })();

  // Budget label update
  function updateBudgetLabel(type) {
    const unit = type === 'sale' ? '‚Ç¨' : '‚Ç¨/mois';
    document.getElementById('budget-unit-min').textContent = unit;
    document.getElementById('budget-unit-max').textContent = unit;
  }
  // Init on load
  const checkedType = document.querySelector('input[name="search_profile[transaction_type]"]:checked');
  if (checkedType) updateBudgetLabel(checkedType.value);
</script>
